
{% extends "_base.html" %}


{% block header %}
    <link rel="stylesheet" href="{{ request.static_url('zam_repondeur:static/choices/choices.min.css') }}">
{% endblock %}


{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{{ request.route_url('lectures_list') }}">Lectures</a></li>
    <li class="breadcrumb-item active" aria-current="page">Ajouter une lecture...</li>
{% endblock %}


{% block body %}
    <h2>Ajouter une lecture...</h2>

    <form action="{{ request.path }}" method="POST">
        <div class="form-group">
            <label for="dossier">Texte de loi</label>
            <select id="select-dossier" name="dossier" class="form-control">
                {% for dossier in dossiers %}
                    <option value="{{ dossier.uid }}" {%- if loop.first %} selected{% endif %}>{{ dossier.titre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="lecture">Lecture</label>
            <select id="select-lecture" name="lecture" class="form-control">
                {% for texte_uid, titre in lectures_by_dossier[dossiers[0].uid].items() %}
                    <option value="{{ texte_uid }}" {%- if loop.first %} selected{% endif %}>{{ titre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <input type="submit" name="submit" value="Ajouter" class="btn btn-primary btn-lg">
            <a href="{{ request.route_url('lectures_list') }}" class="btn">Annuler</a>
        </div>
    </form>

{% endblock %}


{% block scripts %}
<script src="{{ request.static_url('zam_repondeur:static/choices/choices.min.js') }}"></script>
<script type="text/javascript">

    var lectures_by_dossier = {{ lectures_by_dossier | tojson | safe }};
    document.addEventListener("DOMContentLoaded", function() {

        var dossierElem = document.getElementById("select-dossier");
        var dossierChoices = new Choices(dossierElem, {
            shouldSort: false,
        });

        var lectureElem = document.getElementById("select-lecture");
        var lectureChoices;
        updateFancySelectWidget();

        dossierElem.addEventListener("change", function(event) {
            resetFancySelectWidget();
            updateBaseSelectOptions(event.detail.value);
            updateFancySelectWidget();
        }, false);

        function resetFancySelectWidget() {
            lectureChoices.destroy();
        }

        function updateBaseSelectOptions(value) {
            lectureElem.innerHTML = '';
            var choices = lectures_by_dossier[value];
            for (var texte_uid in choices) {
                var elem = document.createElement("option")
                elem.value = texte_uid;
                elem.text = choices[texte_uid];
                lectureElem.appendChild(elem);
            }
        }

        function updateFancySelectWidget() {
            lectureChoices = new Choices(lectureElem, {
                shouldSort: false,
            });
        }

    });
</script>
{% endblock %}
